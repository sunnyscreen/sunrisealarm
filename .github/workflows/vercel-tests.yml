name: Test Suite

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch: # Allow manual trigger

jobs:
  # Run unit tests on every push and PR
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      id: test
      run: npm test
      continue-on-error: false

    - name: Update PR status on success
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const sha = context.payload.pull_request?.head?.sha || context.sha;
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: sha,
            state: 'success',
            description: 'Unit tests passed',
            context: 'tests/unit'
          });

    - name: Update commit status on success
      if: success() && github.event_name != 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const sha = context.sha;
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: sha,
            state: 'success',
            description: 'Unit tests passed',
            context: 'tests/unit'
          });

    - name: Update PR status on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const sha = context.payload.pull_request?.head?.sha || context.sha;
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: sha,
            state: 'failure',
            description: 'Unit tests failed',
            context: 'tests/unit'
          });

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: test-results/
        retention-days: 30

  # Run E2E tests after unit tests pass
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: |
      needs.unit-tests.result == 'success' &&
      !startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      pull-requests: write
      checks: read
      statuses: write
      deployments: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Wait for Vercel deployment to be ready
      uses: actions/github-script@v7
      with:
        script: |
          const branch = context.ref.replace('refs/heads/', '');
          const environment = branch === 'main' ? 'Production' : 'Preview';
          
          core.info(`Waiting for ${environment} deployment for commit: ${context.sha}`);
          
          const maxWaitTime = 300000; // 5 minutes
          const checkInterval = 10000; // 10 seconds
          const startTime = Date.now();
          
          while (Date.now() - startTime < maxWaitTime) {
            try {
              // Search for deployments matching this commit SHA and environment
              let deployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: environment,
                per_page: 5
              });
              
              // If not found by SHA, search by branch name
              if (deployments.data.length === 0) {
                deployments = await github.rest.repos.listDeployments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: branch,
                  environment: environment,
                  per_page: 5
                });
                
                // Filter to match our commit SHA
                deployments.data = deployments.data.filter(d => d.sha === context.sha);
              }
              
              if (deployments.data.length > 0) {
                // Check status of the most recent deployment
                const deployment = deployments.data[0];
                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                
                if (statuses.length > 0) {
                  const latestStatus = statuses[0];
                  
                  if (latestStatus.state === 'success') {
                    const deploymentUrl = latestStatus.target_url || 'https://preview.sunnyscreen.art';
                    core.info(`‚úÖ Deployment successful: ${deploymentUrl}`);
                    return;
                  } else if (latestStatus.state === 'failure' || latestStatus.state === 'error') {
                    core.setFailed(`Deployment failed with state: ${latestStatus.state}`);
                    return;
                  } else {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    core.info(`Deployment is ${latestStatus.state} (waited ${elapsed}s)...`);
                  }
                } else {
                  const elapsed = Math.floor((Date.now() - startTime) / 1000);
                  core.info(`Deployment created but no status yet (waited ${elapsed}s)...`);
                }
              } else {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                core.info(`No deployment found yet for commit ${context.sha.substring(0, 7)} (waited ${elapsed}s)...`);
              }
            } catch (error) {
              core.warning(`Error checking deployment: ${error.message}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, checkInterval));
          }
          
          core.setFailed('Deployment did not become ready within 5 minutes');

    - name: Seed test users
      run: |
        PREVIEW_URL="https://preview.sunnyscreen.art"
        SEED_URL="${PREVIEW_URL}/api/seed-test-users?secret=${{ secrets.SEED_SECRET }}"
        echo "Seeding test users at: ${SEED_URL}"
        curl -X POST "${SEED_URL}" \
          -H "Content-Type: application/json" \
          -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" \
          || echo "Seed failed, continuing anyway"

    - name: Run E2E tests
      id: e2e-tests
      env:
        BASE_URL: https://preview.sunnyscreen.art
        PLAYWRIGHT_BYPASS_HEADER: x-vercel-protection-bypass
        PLAYWRIGHT_BYPASS_VALUE: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
      run: |
        echo "Testing preview deployment at: $BASE_URL"
        npm run test:e2e:preview
      continue-on-error: false

    - name: Update commit status on success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: 'success',
            target_url: 'https://preview.sunnyscreen.art',
            description: 'E2E tests passed',
            context: 'tests/e2e'
          });

    - name: Update commit status on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: 'failure',
            target_url: 'https://preview.sunnyscreen.art',
            description: 'E2E tests failed',
            context: 'tests/e2e'
          });

    - name: Update PR status on failure (for pull_request events)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const prSha = context.payload.pull_request.head.sha;
          
          // Update PR status to failure
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: prSha,
            state: 'failure',
            target_url: 'https://preview.sunnyscreen.art',
            description: 'E2E tests failed on preview deployment',
            context: 'tests/e2e'
          });
          
          core.info(`Updated PR #${prNumber} status to failure`);

    - name: Report E2E test failure
      if: failure()
      run: |
        echo "‚ùå E2E tests failed"
        echo "üìç Preview URL: https://preview.sunnyscreen.art"
        echo "‚è∏Ô∏è  Workflow stopped. Fix issues before retrying."

    - name: Upload E2E test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: test-results/
        retention-days: 30

  # Deploy test results to GitHub Pages after tests complete
  # Only deploy on main/preview branches to comply with environment protection rules
  deploy-test-results:
    name: Deploy Test Results
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    # Run even if tests fail to deploy available results, but only on protected branches
    if: |
      always() &&
      needs.unit-tests.result != 'cancelled' &&
      needs.e2e-tests.result != 'cancelled' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/preview')
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download unit test results artifact
      uses: actions/download-artifact@v4
      with:
        name: unit-test-results
        path: test-results-pages/
        if-no-files-found: ignore
      continue-on-error: true

    - name: Download E2E test results artifact
      uses: actions/download-artifact@v4
      with:
        name: e2e-test-results
        path: test-results-pages/
        if-no-files-found: ignore
      continue-on-error: true

    - name: Prepare test results for Pages
      run: |
        echo "üì¶ Preparing test results for GitHub Pages..."
        mkdir -p test-results-pages
        
        # Find and copy Jest results
        JEST_FILE=$(find test-results-pages -name "jest-results.json" -type f 2>/dev/null | head -1)
        if [ -n "$JEST_FILE" ]; then
          echo "‚úÖ Found Jest results: $JEST_FILE"
          cp "$JEST_FILE" test-results-pages/jest-results.json || true
        elif [ -f "test-results-pages/test-results/jest-results.json" ]; then
          cp test-results-pages/test-results/jest-results.json test-results-pages/jest-results.json
          echo "‚úÖ Copied Jest results (standard path)"
        fi
        
        # Find and copy Playwright results
        PLAYWRIGHT_FILE=$(find test-results-pages -name "playwright-results.json" -type f 2>/dev/null | head -1)
        if [ -n "$PLAYWRIGHT_FILE" ]; then
          echo "‚úÖ Found Playwright results: $PLAYWRIGHT_FILE"
          cp "$PLAYWRIGHT_FILE" test-results-pages/playwright-results.json || true
        elif [ -f "test-results-pages/test-results/playwright-results.json" ]; then
          cp test-results-pages/test-results/playwright-results.json test-results-pages/playwright-results.json
          echo "‚úÖ Copied Playwright results (standard path)"
        fi
        
        # List files for debugging
        echo "üìÅ Files in test-results-pages:"
        find test-results-pages -type f | head -10 || echo "No files found"
        
        # Ensure we have at least one result file, or create empty JSON
        if [ ! -f "test-results-pages/jest-results.json" ]; then
          echo "{}" > test-results-pages/jest-results.json
          echo "‚ö†Ô∏è Created empty Jest results file"
        fi
        if [ ! -f "test-results-pages/playwright-results.json" ]; then
          echo "{}" > test-results-pages/playwright-results.json
          echo "‚ö†Ô∏è Created empty Playwright results file"
        fi

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: test-results-pages/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Promote to production after E2E tests pass on preview branch
  promote-to-production:
    name: Promote to Production (Auto-merge PR)
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    permissions:
      contents: write
      pull-requests: write
      checks: write
      statuses: write
    if: |
      needs.unit-tests.result == 'success' &&
      needs.e2e-tests.result == 'success' &&
      (github.ref == 'refs/heads/preview' || (github.event_name == 'pull_request' && github.base_ref == 'preview'))

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Find PR from preview to main
      id: find-pr
      uses: actions/github-script@v7
      with:
        script: |
          // On PR events, use the PR that triggered the workflow
          if (context.eventName === 'pull_request') {
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Only auto-merge if PR is from preview to main
            if (pr.head.ref === 'preview' && pr.base.ref === 'main') {
              core.info(`Found PR #${pr.number}: ${pr.title}`);
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_sha', pr.head.sha);
              return;
            } else {
              core.info(`PR #${pr.number} is from ${pr.head.ref} to ${pr.base.ref}, skipping auto-merge`);
              core.setOutput('pr_number', '');
              core.setOutput('pr_sha', '');
              return;
            }
          }
          
          // On push events, find the open PR from preview to main
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: 'preview',
            base: 'main',
            state: 'open'
          });
          
          if (prs.length === 0) {
            core.info('No open PR from preview to main found. Skipping auto-merge.');
            core.setOutput('pr_number', '');
            core.setOutput('pr_sha', '');
            return;
          }
          
          const pr = prs[0];
          core.info(`Found PR #${pr.number}: ${pr.title}`);
          core.setOutput('pr_number', pr.number);
          core.setOutput('pr_sha', pr.head.sha);

    - name: Update PR status - Tests passing
      if: steps.find-pr.outputs.pr_sha != ''
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: '${{ steps.find-pr.outputs.pr_sha }}',
            state: 'success',
            target_url: 'https://preview.sunnyscreen.art',
            description: 'All tests passed on preview deployment',
            context: 'tests/e2e'
          });

    - name: Auto-merge PR
      if: steps.find-pr.outputs.pr_number != ''
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.find-pr.outputs.pr_number }};
          
          try {
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              commit_title: `Auto-promote preview to production after E2E tests passed`,
              commit_message: `Preview deployment: https://preview.sunnyscreen.art
          E2E tests: Passed ‚úÖ

          ü§ñ Automated by GitHub Actions`,
              merge_method: 'merge'
            });
            
            core.info(`‚úÖ Successfully merged PR #${prNumber}`);
          } catch (error) {
            if (error.status === 405) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              if (pr.merged) {
                core.info(`PR #${prNumber} was already merged`);
              } else if (!pr.mergeable) {
                core.setFailed(`PR #${prNumber} is not mergeable. Reasons: ${JSON.stringify(pr)}`);
              } else {
                throw error;
              }
            } else {
              throw error;
            }
          }

    - name: Deployment initiated
      run: |
        echo "‚úÖ E2E tests passed on preview"
        echo "üöÄ Auto-merged PR #${{ steps.find-pr.outputs.pr_number }}"
        echo "‚è≥ Vercel will now deploy to production (sunnyscreen.art)"
