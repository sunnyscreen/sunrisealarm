<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunrise Alarm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000000;
            transition: background-color 0.5s ease;
            cursor: none;
        }

        .time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 48px;
            font-weight: 200;
            color: rgba(32, 32, 32, 1);
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="time-display" id="timeDisplay"></div>

    <script>
        const { ipcRenderer } = require('electron');
        const urlParams = new URLSearchParams(window.location.search);
        const DURATION_MINUTES = parseInt(urlParams.get('duration')) || 30;
        const DURATION_MS = DURATION_MINUTES * 60 * 1000;
        const UPDATE_INTERVAL = 500; // Update every 500ms for smooth transition
        const wakeTimeStr = urlParams.get('wakeTime');

        let startTime = null;
        let animationInterval;
        let waitingForWakeTime = false;

        // If wakeTime is provided, calculate when to start the animation
        if (wakeTimeStr) {
            const now = new Date();
            const [hours, minutes] = wakeTimeStr.split(':').map(Number);
            let wakeTime = new Date();
            wakeTime.setHours(hours, minutes, 0, 0);

            // If wake time is in the past today, it must be for tomorrow
            if (wakeTime <= now) {
                wakeTime.setDate(wakeTime.getDate() + 1);
            }

            // Calculate start time (duration before wake time)
            const animStartTime = new Date(wakeTime.getTime() - DURATION_MS);

            if (now < animStartTime) {
                // We're early, wait until animation start time
                waitingForWakeTime = true;
                const msUntilStart = animStartTime - now;
                console.log(`Waiting ${msUntilStart / 1000 / 60} minutes until animation starts`);
                setTimeout(() => {
                    waitingForWakeTime = false;
                    startTime = Date.now();
                    animationInterval = setInterval(animate, UPDATE_INTERVAL);
                    animate();
                }, msUntilStart);
            } else if (now < wakeTime) {
                // We're in the middle of when animation should be running
                const elapsed = now - animStartTime;
                startTime = Date.now() - elapsed;
            } else {
                // Wake time has passed, start immediately
                startTime = Date.now();
            }
        } else {
            // No wake time specified, start immediately (test mode)
            startTime = Date.now();
        }

        function updateTimeDisplay() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('timeDisplay').textContent = `${hours}:${minutes}`;
        }

        function interpolateColor(progress) {
            // Sunrise color progression:
            // Black (0,0,0) -> Deep Blue (10,10,40) -> Red (200,0,0) -> Orange (255,140,60) -> Bright Yellow (255,240,100)

            if (progress < 0.15) {
                // Black to deep blue
                const p = progress / 0.15;
                const r = Math.floor(10 * p);
                const g = Math.floor(10 * p);
                const b = Math.floor(40 * p);
                return `rgb(${r}, ${g}, ${b})`;
            } else if (progress < 0.35) {
                // Deep blue to red
                const p = (progress - 0.15) / 0.2;
                const r = Math.floor(10 + (200 - 10) * p);
                const g = Math.floor(10 * (1 - p));
                const b = Math.floor(40 * (1 - p));
                return `rgb(${r}, ${g}, ${b})`;
            } else if (progress < 0.6) {
                // Red to orange
                const p = (progress - 0.35) / 0.25;
                const r = Math.floor(200 + (255 - 200) * p);
                const g = Math.floor(0 + 140 * p);
                const b = Math.floor(0 + 60 * p);
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Orange to bright yellow
                const p = (progress - 0.6) / 0.4;
                const r = 255;
                const g = Math.floor(140 + (240 - 140) * p);
                const b = Math.floor(60 + (100 - 60) * p);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }

        function animate() {
            if (waitingForWakeTime) {
                // Keep screen black while waiting with small dark clock
                document.body.style.backgroundColor = '#000000';
                const timeDisplay = document.getElementById('timeDisplay');
                timeDisplay.style.color = 'rgba(32, 32, 32, 1)';
                timeDisplay.style.fontSize = '48px';
                return;
            }

            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / DURATION_MS, 1);

            const color = interpolateColor(progress);
            document.body.style.backgroundColor = color;

            // Adjust text color and size for visibility during sunrise
            const timeDisplay = document.getElementById('timeDisplay');
            timeDisplay.style.fontSize = '120px';
            if (progress > 0.5) {
                timeDisplay.style.color = 'rgba(0, 0, 0, 0.3)';
            } else {
                timeDisplay.style.color = 'rgba(255, 255, 255, 0.3)';
            }

            if (progress >= 1) {
                clearInterval(animationInterval);
                // Keep the final bright yellow screen displayed
                document.body.style.backgroundColor = 'rgb(255, 240, 100)';
                timeDisplay.style.color = 'rgba(0, 0, 0, 0.3)';
            }
        }

        // Initialize
        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);

        // Start animation interval (will show black screen if waiting)
        if (!waitingForWakeTime) {
            animationInterval = setInterval(animate, UPDATE_INTERVAL);
        } else {
            // Show black screen with dark gray clock while waiting
            animationInterval = setInterval(animate, UPDATE_INTERVAL);
        }
        animate(); // Call immediately for first frame

        // Close handlers
        document.addEventListener('click', () => {
            ipcRenderer.send('close-alarm');
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                ipcRenderer.send('close-alarm');
            }
        });
    </script>
</body>
</html>
